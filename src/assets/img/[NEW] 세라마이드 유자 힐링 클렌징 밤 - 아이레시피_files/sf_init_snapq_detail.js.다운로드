/**
 * Created by intop on 2017-11-14.
 */

if (typeof(sfsnapQtest) == 'undefined') sfsnapQtest = false;


var snapQ_init = function () {
    var api_domain = 'https://snapfit.co.kr';
    this.isTestUser = true;
    this.isSfValid = function (value) {
        if (value === false || value == 'false' || value == "" || value == null || value == 'null' || value == 'undefined' || value == undefined || typeof(value) == 'undefined')
            return false;
        else
            return true;
    }

    this.make_iframe_url = function (datas) {
        for(var key in datas){
            if(param != 0) {
                param += '&';
            }
            param += key + '=' + datas[key];
            i++;
        }
    }

    this.sendinitjsonp = function (requesturl, sendparam) {
        var scripttag = document.createElement("script");
        scripttag.type = 'text/javascript';
        scripttag.async = true;
        // scripttag.src = '//snapfit.co.kr/Resultview/draw_snapfit_main_page';
        scripttag.src = requesturl + sendparam;
        document.head.appendChild(scripttag);
    }

    this.sendXmlHttpRequest = function (requesturl, param, devicetype, callback) {

        if (typeof fallbackToGet === 'undefined' || fallbackToGet === null) {
            fallbackToGet = true;
        }

        try {
            // we use the progid Microsoft.XMLHTTP because
            // IE5.5 included MSXML 2.5; the progid MSXML2.XMLHTTP
            // is pinned to MSXML2.XMLHTTP.3.0
            var xhr = window.XMLHttpRequest
                ? new window.XMLHttpRequest()
                : window.ActiveXObject
                    ? new ActiveXObject('Microsoft.XMLHTTP')
                    : null;


            xhr.open('POST', requesturl, true);

            // fallback on error
            xhr.onreadystatechange = function () {
                if (this.readyState === 4 && !(this.status >= 200 && this.status < 300) && fallbackToGet) {
                } else if (this.readyState === 4 && this.status == 200 && fallbackToGet) {
                    callback(xhr.responseText, devicetype);
                } else {
                    if (typeof callback === 'function') {
                    }
                }
            };

            var requestContentType = 'application/x-www-form-urlencoded; charset=UTF-8';
            xhr.setRequestHeader('Content-Type', requestContentType);
            xhr.send(param);
        } catch (e) {
            if (fallbackToGet) {
                // fallback
                // getI(request, callback);
            }

        }
    }

    this.send_sf_init_detail = function (url, datas) {

        var param = '';

        var i = 0;
        for(var key in datas){
            if(param != 0) {
                param += '&';
            }
            param += key + '=' + datas[key];
            i++;
        }

        sendinitjsonp(url, param);
    }

    this.sf_get_value = function (idselector) {
        var selector = document.getElementById(idselector);
        if (selector) {
            return selector.value;
        } else {

            return null;
        }
    }
    this.sf_get_solutiontype = function () {
        var selector = document.getElementById('solutiontype');
        if (selector) {
            return selector.innerText;
        } else {
            return null;
        }
    }

    this.sf_isdetail_page = function () {
        var selector = document.getElementById('sf_isdetail_page');
        if (selector) {
            return selector.innerText;
        } else {
            return null;
        }
    }

    this.sf_get_user_id = function () {

        var user_id_selector = document.getElementsByClassName('xans-member-var-id');
        if (!user_id_selector || user_id_selector.length <= 0) {
            return null;
        }

        if (user_id_selector.length == 1) {
            return user_id_selector[0].innerText ||  user_id_selector[0].textContent
        } else if (user_id_selector.length > 1) {
            return user_id_selector[0].innerText ||  user_id_selector[0].textContent
        } else {
            return null;
        }
    }


    this.send_url = function (url, senddata) {
        if(!url || !senddata) {
            return false;
        }

        this.send_sf_init_detail(url, senddata);

        //url : //snapfit.co.kr/Sq_detail_view/init_detail_view?
        // var is_log_on = document.getElementsByClassName('xans-member-var-id');
        // if (is_log_on && is_log_on.length > 0) {
        //
        //     if (is_log_on[0].innerText || is_log_on[0].textContent) {
        //         var userid = is_log_on[0].innerText || is_log_on[0].textContent;
        //         if (userid && userid != 'undefined') {
        //             senddata['user_id'] = encodeURIComponent(userid);
        //         }
        //         this.send_sf_init_detail('//snapfit.co.kr/Sq_detail_view/init_detail_view?', senddata);
        //     } else {
        //
        //         var solutiontype = this.sf_get_solutiontype();
        //         if (typeof(solutiontype) != 'undefined' && solutiontype && solutiontype == 'cafe24') {
        //             var count = 0;
        //             var interval = setInterval(function () {
        //                 var userid = this.sf_get_user_id();
        //                 if (userid || count >= 32) {
        //                     clearInterval(interval);
        //                     if (userid && userid != 'undefined') {
        //                         senddata['user_id'] = encodeURIComponent(userid);
        //                     }
        //                     this.send_sf_init_detail(url, senddata);
        //                 }
        //                 count++;
        //             }, 200);
        //         } else {
        //             this.send_sf_init_detail(url, senddata);
        //         }
        //     }
        // } else {
        //     this.send_sf_init_detail(url, senddata);
        // }
    }

    this.sf_get_solutiontype = function () {
        var selector = document.getElementById('solutiontype');
        if (selector) {
            return selector.innerText;
        } else {
            return null;
        }
    }

    this.getUrlParameterNotRegex = function(BaseUrl,  itemnumberindex, cateindex){
        if (BaseUrl.length == 0)
            return null;

        var result = '';
        //BaseUrl = encodeURIComponent(BaseUrl);
        if( BaseUrl.indexOf('http://') != -1 )
            result = BaseUrl.split('http://');
        if( BaseUrl.indexOf('https://') != -1 )
            result = BaseUrl.split('https://');
        else
            result = [BaseUrl];

        var urlparseresult = '';
        if( result.length == 1 )
            urlparseresult = result[0].split('/');
        else if( result.length == 2 )
            urlparseresult = result[1].split('/');

        result = [];
        result['itemno'] = null;
        result['itemcate'] = null;

        if(urlparseresult.length >0 && urlparseresult.length > itemnumberindex && (itemnumberindex in urlparseresult) == true)
            result['itemno'] = urlparseresult[itemnumberindex];


        if(urlparseresult.length >0 && urlparseresult.length > cateindex && (cateindex in urlparseresult) == true)
            result['itemcate'] = urlparseresult[cateindex];

        return result;
    }

    this.getUrlParameterByCafe24Keyvalue = function(BaseUrl){
        if (!BaseUrl || BaseUrl.length <= 0)
            return null;

        var item_info = {};
        if (BaseUrl.indexOf('http://') != -1)
            BaseUrl = BaseUrl.split('http://');
        if (BaseUrl.indexOf('https://') != -1)
            BaseUrl = BaseUrl.split('https://');
        else
            BaseUrl = [BaseUrl];


        var urlparseresult = '';
        if (BaseUrl.length == 1)
            urlparseresult = BaseUrl[0].split('?');
        else if (BaseUrl.length == 2)
            urlparseresult = BaseUrl[1].split('?');

        if (!urlparseresult || urlparseresult.length < 1)
            return null;

        urlparseresult = urlparseresult[1];
        var sURLVariables = urlparseresult.split('&');
        var sParameterName = null;
        var result = {};

        for (var i = 0; i < sURLVariables.length; i++) {
            sParameterName = sURLVariables[i].split('=');
            if (sParameterName[0] == 'product_no') {
                if (!sParameterName[1]) {
                    return null;
                } else {
                    item_info['itemno'] = sParameterName[1];
                    return item_info;
                }
            }
        }
        return null;
    }

    this.parse_item_number=function (url) {
        var store_type = this.sf_get_solutiontype();

        if (store_type == 'cafe24') {
            var result =  this.getUrlParameterNotRegex(url, 3, 5);
            if(result == null || !result ||  result['itemno'] == null ||  !result['itemno'] )
                result = this.getUrlParameterByCafe24Keyvalue(url);

        } else if (store_type == 'makeshop') {
            var result = this.getUrlParameterByMakeshopKeyvalue(url);
            // if(!result || result == null)
            //     result = this.getUrlParameterNotRegex($url, $product_key, $cate_key);
        }


        return result;
    }

    this.getUrlParameterByMakeshopKeyvalue = function (BaseUrl) {
        var cat1key = 'xcode';
        var cat2key = 'mcode';
        var cat3key = 'scode';
        var curcatkey = null;
        if(!BaseUrl || BaseUrl.length <= 0 )
            return null;

        if( BaseUrl.indexOf('http://') != -1 )
            BaseUrl = BaseUrl.split('http://');
        if( BaseUrl.indexOf('https://') != -1 )
            BaseUrl = BaseUrl.split('https://');
        else
            BaseUrl = [BaseUrl];


        var urlparseresult = '';
        if( BaseUrl.length == 1 )
            urlparseresult = BaseUrl[0].split('?');
        else if( BaseUrl.length == 2 )
            urlparseresult = BaseUrl[1].split('?');

        if(!urlparseresult || urlparseresult.length < 1)
            return null;

        urlparseresult = urlparseresult[1];
        var sURLVariables = urlparseresult.split('&');
        var sParameterName = null;
        var result = {};
        result['itemno'] =  null;
        result['itemcate'] = '';

        for (var i = 0; i < sURLVariables.length; i++) {
            sParameterName = sURLVariables[i].split('=');
            if (sParameterName[0] == 'branduid') {
                if(!sParameterName[1]) {
                    result['itemno'] = null
                } else {
                    result['itemno']  = sParameterName[1];
                }
            } else if(sParameterName[0] == cat1key || sParameterName[0] == cat2key || sParameterName[0] == cat3key ){
                if(curcatkey != 'scode' && sParameterName[1] && sParameterName[1] != '' ){
                    if((sParameterName[0] == 'xcode' && !curcatkey) ||
                        (sParameterName[0] == 'mcode' && (curcatkey == 'xcode' || !curcatkey)) ||
                        (sParameterName[0] == 'scode' && (curcatkey == 'xcode' || curcatkey == 'mcode' || !curcatkey))) {
                        result['itemcate'] += sParameterName[1];
                        curcatkey  = sParameterName[0];
                    }
                }
            }
        }
        return result;
    }

    this.make_default_send_info = function(){
        var type = encodeURIComponent(this.sf_get_value('sf_draw_type'));
        var store_name = encodeURIComponent(this.sf_get_value('sf_store_name'));

        var url = encodeURIComponent(location.href);
        var senddata = {};
        senddata['url'] = url;
        senddata['device_type'] = encodeURIComponent(type);
        senddata['store_username'] = '';
        senddata['chart_id'] = '';
        senddata['draw_target'] = 'iframe';
        senddata['user_id'] = this.sf_get_user_id();
        senddata['referer'] = encodeURIComponent(document.referrer);
        var store_username = this.sf_get_value('sf_store_name');
        if (store_username && store_username != 'undefined') {
            senddata['store_username'] = encodeURIComponent(store_username);
        }

        if (store_username && store_username != 'undefined') {
        }

        var solutiontype = this.sf_get_solutiontype();
        senddata['solution_type'] = solutiontype;

        return senddata;
    }

    this.get_item_urls = function(list_selector, item_selector){
        if(!list_selector || !item_selector ){
            return false;
        }

        var item_container_list =  document.querySelectorAll(list_selector);
        if(!item_container_list) {
            return false;
        }

        var itemurlselector = item_selector;
        if(!itemurlselector)
            return false;

        var item_number_list = [];
        for (var i=0; i<item_container_list.length; i++){
            var item_container = item_container_list[i];
            var item_list = item_container.children;
            for (var j =0; j<item_list.length; j++){
                var item=item_list[j];
                var itemlinkselector = item.querySelector(itemurlselector);
                if(!itemlinkselector){
                    continue;
                }

                var url = itemlinkselector.getAttribute('href');
                if(!url || url == '#') {
                    continue;
                }


                var item_info = this.parse_item_number(url);
                if(!item_info) {
                    continue;
                }
                item_number_list.push(item_info['itemno']);
            }
        }
        return item_number_list;
    }


    this.get_relation_items = function (data) {
        var item_number_list = [];
        if (!data.pc_relation_list_selector_id) {
            return false;
        }
        if (!data.pc_relation_url_selector_id) {
            return false;
        }
        var list_selector = data.pc_relation_list_selector_id;
        var item_selector = data.pc_relation_url_selector_id;
        var item_id = data.item_id;


        if(list_selector && item_selector) {
            item_number_list = this.get_item_urls(list_selector, item_selector);
            if (item_number_list && typeof(item_number_list) != 'undefined' && Array.isArray(item_number_list) == true) {
            }else{
                return false;
            }

            var senddata = this.make_default_send_info();
            senddata['relation_item_list'] = item_number_list;
            senddata['item_id'] = item_id;
            // 해당 id값 view 카운트 증가
            this.send_url(api_domain+'/Sq_detail_view/set_relation_items?', senddata);
        }
    }

    this.view_count_add = function(data){
        var item_container_list =  document.querySelectorAll(data.list_selector);
        var itemurlselector = data.item_selector;
        var item_number_list = [];
        for (var i=0; i<item_container_list.length; i++){
            var item_container = item_container_list[i];
            var item_list = item_container.children;
            for (var j =0; j<item_list.length; j++){
                var item=item_list[j];
                var itemlinkselector = item.querySelector(itemurlselector);
                if(!itemlinkselector){
                    continue;
                }
                var url = itemlinkselector.getAttribute('href');
                if(!url || url == '#') {
                    continue;
                }
                var item_info = this.parse_item_number(url);
                if(!item_info) {
                    continue;
                }

                item_number_list.push(item_info['itemno']);
            }
        }

        var senddata = this.make_default_send_info();

        senddata['view_item_list'] = item_number_list;

        // 해당 id값 view 카운트 증가
        this.send_url(api_domain+'/Sq_detail_view/init_detail_view?', senddata);
    }

    this.sendonetailpage = function () {
        var type = encodeURIComponent(this.sf_get_value('sf_draw_type'));
        var store_name = encodeURIComponent(this.sf_get_value('sf_store_name'));
        var url = encodeURIComponent(location.href);
        var senddata = {};
        senddata['url'] = url;
        senddata['device_type'] = encodeURIComponent(type);
        senddata['store_username'] = '';
        senddata['user_id'] = this.sf_get_user_id();
        senddata['referer'] = encodeURIComponent(document.referrer);
        var store_username = this.sf_get_value('sf_store_name');
        if(store_username && store_username != 'undefined') {
            senddata['store_username'] = encodeURIComponent(store_username);
        }

        var solutiontype = this.sf_get_solutiontype();
        senddata['solution_type'] = solutiontype;


        if (store_username && store_username != 'undefined') {
            var is_log_on = document.getElementsByClassName('xans-member-var-id');
            if (is_log_on && is_log_on.length > 0) {
                if (is_log_on[0].innerText || is_log_on[0].textContent) {
                    var userid = is_log_on[0].innerText || is_log_on[0].textContent;
                    if( userid && userid != 'undefined') {
                        senddata['user_id'] = encodeURIComponent(userid);
                    }
                    this.send_sf_init_detail(api_domain+'/Sq_detail_view/init_detail_view?', senddata, type);
                } else {
                    if (typeof(solutiontype) != 'undefined' && solutiontype && solutiontype == 'cafe24') {
                        var count = 0;
                        var interval = setInterval(function () {
                            var userid = this.sf_get_user_id();
                            if (userid || count >= 32) {
                                clearInterval(interval);
                                if (userid && userid != 'undefined') {
                                    senddata['user_id'] = encodeURIComponent(userid);
                                }
                                this.send_sf_init_detail(api_domain+'/Sq_detail_view/init_detail_view?', senddata, type);
                            }

                            count++;
                        }, 200);
                    } else {
                        this.send_sf_init_detail(api_domain+'/Sq_detail_view/init_detail_view?', senddata, type);
                    }
                }
            } else {
                this.send_sf_init_detail(api_domain+'/Sq_detail_view/init_detail_view?', senddata, type);
            }
        }
    }

    this.sendonotherpage = function () {
        var senddata = this.make_default_send_info();
        this.send_url(api_domain+'/Sq_detail_view/get_shop_item_selector?', senddata);
    }

    this.init = function () {
        var sf_isdetail_page = this.sf_isdetail_page();
        if(sf_isdetail_page == 1){
            sendonetailpage();
        } else {
            // sendonotherpage();
        }
    }();

}();
